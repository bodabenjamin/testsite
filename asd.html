<!DOCTYPE html>
<html lang="hu">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Arbitrázs Kalkulátor – Dark Mode</title>
  <style>
 body {
    background: linear-gradient(135deg, #121212, #1e1e1e);
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    display: flex;
    min-height: 100vh;
    margin: 0;
    justify-content: center;
    padding: 20px 10px;
    color: #e0e0e0;
    overflow-y: auto;
  }
  .calculator {
    background: rgba(34,40,49,0.85);
    border-radius: 20px;
    box-shadow: 0 8px 24px rgba(0,0,0,0.18), 0 2px 8px #00ffa825;
    backdrop-filter: blur(8px);
    border: 1px solid rgba(255,255,255,0.05);
    padding: 30px 35px;
    max-width: 400px;
    width: 100%;
    text-align: center;
    margin: auto;

    opacity: 0;
    transform: scale(0.94) translateY(30px);
    transition: opacity 0.6s cubic-bezier(.6,1.5,.7,1), transform 0.6s cubic-bezier(.6,1.5,.7,1);
    will-change: opacity, transform;
    position: relative;
  }
  .calculator.visible { opacity: 1; transform: scale(1) translateY(0); }

  .logo-wrapper { display: flex; justify-content: center; align-items: center; margin-bottom: 22px; }
  .logo {
    width: 68px; height: 68px; object-fit: cover; border-radius: 50%;
    border: 3px solid rgba(255,255,255,0.07);
    box-shadow: 0 4px 14px #00ff8855; background: #fff0; display: block; margin: 0 auto;
  }
  h1 { margin: 0 0 22px; font-weight: 700; color: #00ff88; font-size: 1.8rem; }

  label { display: block; text-align: left; margin-top: 16px; margin-bottom: 8px; font-weight: 600; color: #b0b0b0; font-size: 1rem; }

  /* ===== FINOM TUNING: minden number input (Odds + tét) ===== */
  input[type="number"], .value-input {
    width: 100%; padding: 12px 14px; font-size: 1rem; border-radius: 12px;
    border: 2px solid #3e4650; background: linear-gradient(180deg,#20262e 0%, #1a2128 100%);
    color: #e0e0e0; outline: none;
    transition: border-color .2s ease, box-shadow .25s ease, background .2s ease;
    box-sizing: border-box; margin-bottom: 4px;
    box-shadow: inset 0 1px 0 rgba(255,255,255,.04), inset 0 0 0 9999px rgba(0,0,0,.02);
    font-variant-numeric: tabular-nums;
  }
  input[type="number"]::placeholder { color: #7f8791; }
  input[type="number"]:hover { border-color: #4a5360; }
  input[type="number"]:focus {
    border-color: #00ff88;
    box-shadow:
      0 0 0 3px rgba(0,255,136,.15),
      0 0 22px rgba(0,255,136,.12),
      inset 0 1px 0 rgba(255,255,255,.05);
    background: linear-gradient(180deg,#222a33 0%, #1b232a 100%);
  }

  /* ===== FINOM TUNING: Odds cím ===== */
  .odds-title{
    color:#e8fbff; font-weight:800; letter-spacing:.015em;
    display:flex; align-items:center; gap:8px; margin-bottom:6px;
  }
  .odds-title::before{
    content:""; width:8px; height:8px; border-radius:50%;
    background:#00e5ff; box-shadow:0 0 10px #00e5ff66;
  }

  button, .book-link {
    margin-top: 24px; width: 100%; display: inline-block; text-decoration: none; text-align: center;
    font-weight: 700; font-size: 1.2rem; padding: 14px 0; border-radius: 12px; cursor: pointer;
  }
  button {
    background: linear-gradient(90deg, #00c853, #009624); border: none; color: white;
    box-shadow: 0 4px 15px rgba(0, 200, 83, 0.7); transition: background 0.3s ease, box-shadow 0.25s ease;
  }
  button:hover, button:focus { background: linear-gradient(90deg, #009624, #00c853); box-shadow: 0 6px 20px rgba(0, 200, 83, 0.9); }

  .book-link {
    background: linear-gradient(90deg, #00ffcc, #00bfa5); color: #1e1e1e;
    box-shadow: 0 4px 15px rgba(0, 255, 204, 0.7); transition: background 0.3s ease, box-shadow 0.25s ease; margin-top: 18px;
  }
  .book-link:hover, .book-link:focus { background: linear-gradient(90deg, #00bfa5, #00ffcc); box-shadow: 0 6px 20px rgba(0, 255, 204, 0.9); }

  /* Finom elválasztó a fogadóiroda gombok után (csak ha nem üres) */
  #bookmakerButtons:not(:empty){ margin-top: 6px; margin-bottom: 12px; }
  #bookmakerButtons:not(:empty)::after{
    content:""; display:block; height:1px; margin:12px 0 4px 0;
    grid-column: 1 / -1;
    background: linear-gradient(90deg, transparent, #00ffcc33, transparent);
  }

  .result { margin-top: 28px; font-weight: 700; font-size: 1.15rem; line-height: 1.5; color: #e0e0e0; text-align: left; }
  .row { margin-top: 5px; display: flex; justify-content: space-between; align-items: flex-start; flex-wrap: wrap; gap: 8px; }

  /* ===== TÉT CÍM FINOM TUNING (visszarakva) ===== */
  .label-text { color: #b0b0b0; font-weight: 600; }
  .stake-title{
    color:#e8ffee; font-weight: 800; letter-spacing:.015em;
    display:flex; align-items:center; gap:8px;
  }
  .stake-title::before{
    content:""; width:8px; height:8px; border-radius:50%;
    background:#00ff88; box-shadow:0 0 10px #00ff8866;
  }

  .value-input { text-align: right; }
  .value-text { color: #00ff88; font-weight: 800; text-shadow: 0 0 6px #00ff8844; font-variant-numeric: tabular-nums; }
  .guaranteed-label { color: #a0ffb4; font-weight: 700; }
  .guaranteed-value { color: #a0ffb4; font-weight: 800; text-shadow: 0 0 8px #a0ffb455; white-space: nowrap; font-variant-numeric: tabular-nums; }
  .tip-label { color: #ffd166; font-weight: 700; font-size: 1rem; }
  .tip-value { color: #ffd166; font-weight: 600; font-size: 0.95rem; line-height: 1.3; margin-bottom: 8px; text-align: left; }
  .eur-value, .ft-value { font-size: 0.78em; color: #23ffd6; font-weight: 600; font-variant-numeric: tabular-nums; }

  .alt-wrap{ display:flex; justify-content:flex-end; align-items:center; gap:8px; margin-top: 4px; min-height: 1.2em; }
  .swap-emoji-inline{ width: 1em; height: 1em; cursor: pointer; user-select: none; opacity:.9; }
  .swap-emoji-inline:hover{ opacity:1; }

  .error { color: #ff5252; margin-top: 14px; font-weight: 600; }

  #stake, label[for="stake"] { display: none; }

  .input-with-copy { position: relative; width: 100%; }
  .value-input.copyable { padding-right: 52px; }

  button.copy-btn {
    position: absolute; right: 8px; top: 8px;
    width: auto; min-width: 36px; height: 32px; padding: 0 8px; margin: 0;
    display: inline-flex; align-items: center; justify-content: center;
    border-radius: 8px; border: 1px solid #00ff88;
    background: #173329; color: #bfffdc; font-size: 0.95rem; line-height: 1;
    box-shadow: 0 2px 6px rgba(0,0,0,0.25); z-index: 2; cursor: pointer;
    transition: transform .08s ease, box-shadow .2s ease;
  }
  button.copy-btn:hover, button:focus { background: #173329; box-shadow: 0 3px 10px rgba(0,255,136,0.25); }
  button.copy-btn:active { transform: scale(0.98); }
  button.copy-btn.copied { border-color: #62ff9d; color: #62ff9d; }

  @media (max-width: 400px) {
    .calculator { padding: 25px 20px; width: 100%; box-shadow: none; border-radius: 12px; }
    h1 { font-size: 1.5rem; margin-bottom: 18px; }
    label { font-size: 0.9rem; margin-top: 14px; margin-bottom: 6px; }
    input[type="number"], .value-input { font-size: 0.95rem; padding: 10px 12px; width: 100%; }
    button, .book-link { font-size: 1.1rem; padding: 12px 0; }
    .result { font-size: 1rem; margin-top: 22px; }
    #bookmakerButtons{ gap: 3px; }
    .row { margin-top: 5px; flex-wrap: wrap; }
    .logo { width: 50px; height: 50px; }
    .logo-wrapper { margin-bottom: 14px; }
    button.copy-btn { right: 6px; top: 6px; height: 30px; min-width: 34px; }

    .guaranteed-row .guaranteed-label,
    .guaranteed-row .guaranteed-value { font-size: .95rem; }
  }

  .is-positive { color: #a0ffb4 !important; text-shadow: 0 0 8px #a0ffb455 !important; }
  .is-zero     { color: #ffd166 !important; text-shadow: 0 0 8px #ffd16655 !important; }
  .is-negative { color: #ff6b6b !important; text-shadow: 0 0 8px #ff6b6b55 !important; }

  /* === Modálok, popupok === */
  .modal-backdrop{ position: fixed; inset: 0; background: rgba(0,0,0,.45); opacity: 0; pointer-events: none; transition: opacity .18s ease; z-index: 999; }
  .modal-backdrop.show{ opacity: 1; pointer-events: auto; }
  .modal{ position: fixed; inset: 0; display: grid; place-items: center; z-index: 1000; pointer-events: none; }
  .modal .box{
    width: min(92vw, 420px); background: rgba(34,40,49,.98); border:1px solid rgba(255,255,255,.08);
    border-radius:16px; padding:16px; box-shadow: 0 20px 60px rgba(0,0,0,.45);
    transform: translateY(10px) scale(.98); opacity: 0; transition: transform .2s ease, opacity .2s ease;
  }
  .modal.show{ pointer-events: auto; }
  .modal.show .box{ transform: translateY(0) scale(1); opacity:1; }
  .modal .hdr{ display:flex; align-items:center; justify-content: space-between; gap:12px; margin-bottom:8px; }
  .modal .title{ font-weight:800; color:#e6ffe6; font-size:1.05rem; }
  .modal .close-x{ cursor:pointer; opacity:.85; user-select:none; font-size:1.1rem; padding:6px; }

  .settings-btn{
    position:absolute; top:12px; right:12px;
    width:36px; height:36px; border-radius:8px; padding:0;
    border:1px solid rgba(255,255,255,.08);
    background: rgba(34,40,49,.8); backdrop-filter: blur(6px);
    display:flex; align-items:center; justify-content:center; cursor:pointer;
    box-shadow: 0 4px 12px rgba(0,0,0,.25);
    z-index: 3;
  }
  .settings-btn:hover{ box-shadow: 0 6px 16px rgba(0,0,0,.35); }
  .settings-btn img{ width:22px; height:22px; display:block; }

  .setting-row{ display:flex; align-items:center; gap:12px; padding:10px 0; }
  .setting-row .lbl{ font-weight:700; color:#e6ffe6; }
  .setting-row .desc{ color:#aab; font-size:.92rem; line-height:1.25; margin-top:2px; }

  .toggle{ margin-left:auto; position:relative; width:56px; height:30px; -webkit-tap-highlight-color:transparent; }
  .toggle input{ display:none; }
  .toggle .track{
    position:absolute; inset:0; border-radius:999px; overflow:hidden;
    background:#3a414a; box-shadow: inset 0 1px 6px rgba(0,0,0,.35);
    transition: background .18s ease;
  }
  .toggle .knob{
    position:absolute; top:3px; left:3px; width:24px; height:24px; border-radius:50%;
    background:#f0f0f0; box-shadow: 0 2px 8px rgba(0,0,0,.35);
    transition: transform .18s ease, background .18s ease;
  }
  .toggle input:checked + .track{ background: linear-gradient(90deg,#00c853,#00e676); }
  .toggle input:checked + .track .knob{ transform: translateX(26px); background:#fff; }

  .popup-modal .title{ font-weight:800; color:#ffd166; }
  .popup-modal .txt{ color:#e0e0e0; line-height:1.35; margin-top:6px; }
  .modal .btns{ display:flex; gap:10px; justify-content:flex-end; margin-top:14px; flex-wrap:wrap; }
  .inline-link{ border:1px solid #00ff88; background:#173329; color:#bfffdc; border-radius:10px; padding:10px 14px; text-decoration:none; font-weight:700; }

  .calc-toast{
    position: absolute;
    top: 10px; left: 100%; margin-left: 12px;
    width: 320px; max-width: 36vw;
    background: rgba(34,40,49,.98);
    border:1px solid rgba(255,255,255,.08);
    border-radius:14px; padding:12px 14px;
    box-shadow: 0 14px 40px rgba(0,0,0,.35);
    opacity: 0; transform: translateY(-6px); transition: opacity .2s ease, transform .2s ease;
    z-index: 2;
  }
  .calc-toast.show{ opacity:1; transform: translateY(0); }
  .calc-toast .title{ font-weight:800; color:#ffd166; font-size:1rem; }
  .calc-toast .txt{ color:#e0e0e0; font-size:.95rem; line-height:1.3; margin-top:4px; }
  .calc-toast .btns{ display:flex; justify-content:flex-end; gap:8px; margin-top:10px; }

  @media (hover:none) and (pointer:coarse), (max-width: 700px) {
    .settings-btn { display: none !important; }
    #settingsModal, #settingsBackdrop { display: none !important; }
  }

  /* ===== F1/F2 pill ===== */
  .bet-pill{
    align-self: flex-start;
    display: inline-flex;
    padding: 6px 12px 6px 14px;
    border-radius: 12px;
    font-size: .85rem;
    font-weight: 700;
    background: linear-gradient(90deg, rgba(0,255,136,.10), rgba(0,255,136,.05));
    border: 1px solid rgba(0,255,136,.28);
    color: #c8ffdf;
    box-shadow: 0 2px 8px rgba(0,255,136,.08);
    margin: 0 0 8px 0;
    max-width: 100%;
    line-height: 1.15;
    word-break: break-word;
    position: relative;
  }
  .bet-pill::before{
    content:""; position:absolute; left:6px; top:6px; bottom:6px; width:3px;
    border-radius:3px; background:#00ff88b3; box-shadow:0 0 10px #00ff8866;
  }

  /* Mérkőzés badge */
  .match-wrap{ display:flex; justify-content:center; align-items:center; margin: -6px 0 12px 0; }
  .match-pill{
    display:inline-flex; align-items:center; gap:8px;
    padding: 8px 12px; border-radius: 9999px; font-size: .92rem; font-weight: 800;
    background: rgba(0,255,204,.08); border: 1px solid rgba(0,255,204,.22);
    color: #d6fff6; box-shadow: 0 2px 10px rgba(0,255,204,.08);
    max-width: 100%; line-height: 1.15; word-break: break-word; text-align: center;
  }
  .match-pill .dot{ width:8px; height:8px; border-radius:50%; background:#00ffcc; box-shadow:0 0 8px #00ffcc88; flex:0 0 auto; }

  /* --- Bookmaker gombok sorban + Gyors fogadás gomb --- */
  #quickBetWrap:empty { display: none; }
  #quickBetWrap .book-link { margin-top: 18px; }
  #bookmakerButtons {
    display: grid;
    grid-template-columns: repeat(2, minmax(0, 1fr));
    gap: 6px;
  }
  #bookmakerButtons .book-link { margin-top: 0; }
  @media (max-width: 400px) { #bookmakerButtons { gap: 10px; } }
</style>
</head>
<body>
  <div class="calculator" role="main" aria-label="Arbitrázs kalkulátor">

    <!-- Beállítások gomb -->
    <button class="settings-btn" id="settingsBtn" aria-label="Beállítások">
      <img src="123.png" alt="Beállítások">
    </button>

    <!-- Beállítások -->
    <div class="modal-backdrop" id="settingsBackdrop" hidden></div>
    <div class="modal" id="settingsModal" hidden>
      <div class="box">
        <div class="hdr">
          <div class="title">Beállítások</div>
          <span class="close-x" id="settingsClose">✕</span>
        </div>

        <div class="setting-row">
          <div style="max-width: calc(100% - 120px);">
            <div class="lbl">Fogadóirodák automatikus nyitása</div>
            <div class="desc">Betöltéskor a linkelt irodák megnyitása új fülön (ha szerepelnek az URL-ben).</div>
          </div>
          <label class="toggle" title="Be/Ki">
            <input type="checkbox" id="autoOpenToggle">
            <span class="track"><span class="knob"></span></span>
          </label>
        </div>

        <hr style="border:none; border-top:1px solid rgba(255,255,255,.08); margin:12px 0;">

        <div class="setting-row">
          <div style="max-width: calc(100% - 120px);">
            <div class="lbl">Segítség</div>
            <div class="desc">Ha az automatikus nyitás nem működik, olvasd el az útmutatót a Discordon.</div>
          </div>
          <a id="guideLink" class="inline-link" href="#" target="_blank" rel="noopener" title="Útmutató">Útmutató</a>
        </div>
      </div>
    </div>

    <div class="logo-wrapper">
      <img src="logo21.png" alt="Logó" class="logo" />
    </div>

    <h1>Arbitrázs Kalkulátor</h1>

    <!-- Hidden mezők -->
    <input type="text" id="odds1Book" hidden>
    <input type="text" id="odds2Book" hidden>
    <input type="text" id="Meccs" hidden>
    <input type="text" id="F1" hidden>
    <input type="text" id="F2" hidden>

    <!-- Odds mezők: egymás alatt, hint nélkül -->
    <label for="odds1" id="labelOdds1" class="odds-title">Odds 1</label>
    <input type="number" id="odds1" step="0.01" min="1.01" placeholder="pl. 1,74" value="1.74" />

    <label for="odds2" id="labelOdds2" class="odds-title">Odds 2</label>
    <input type="number" id="odds2" step="0.01" min="1.01" placeholder="pl. 2,63" value="2.63" />

    <!-- Teljes tét (rejtett, belső) -->
    <label for="stake">Teljes tét (Ft)</label>
    <input type="number" id="stake" step="1" min="1" placeholder="pl. 10000" value="10000" />

    <!-- Gyors fogadás gomb + irodák -->
    <div id="quickBetWrap"></div>
    <div id="bookmakerButtons"></div>

    <button id="calcButton" type="button" onclick="initCalculate()" aria-label="Számolás indítása">
      Számolás
    </button>

    <div id="error" class="error" role="alert"></div>
    <div id="result" class="result" aria-live="polite"></div>
  </div>

  <script>
  // === Hidden mezők olvasása (helper) ===
  const _hidden = id => document.getElementById(id);
  const _getHiddenVal = id => {
    const el = _hidden(id);
    return (el && el.value && String(el.value).trim() !== '') ? el.value : null;
  };
  const _getBookVal = key => _getHiddenVal(key) ?? (new URLSearchParams(window.location.search)).get(key);

  // ==== Alapbeállítások ====
  const eurRate = 393;
  const ronRate = 80; // 1 RON ≈ 80 HUF
  const GUIDE_URL = "https://discord.com/channels/1352389902033096724/1400422649502502953/1402328347480162324";
  const POPUP_AUTO_DISMISS_MS = 7500;

  const bookmakers = {
    tippmixpro: { label: "TippMixPro", url: "https://www.tippmixpro.hu/" },
    vegas:      { label: "Vegas",      url: "https://vegas.hu/betting" },
    piwi247:    { label: "Piwi247",    url: "https://www.piwi247.com/sports" },
    boabet:     { label: "BoaBet",     url: "https://www.boabet.com/" },
    betinia:    { label: "Betinia",    url: "https://betinia.com/hu/" },
    betinasia:  { label: "BetInAsia",  url: "https://black.betinasia.com/sportsbook/football" },
    blaze:      { label: "Blaze",      url: "https://blaze.com/en/" },
    "20bet":    { label: "20bet",      url: "https://20bet.com/hu" },
    ivibet:     { label: "Ivibet",     url: "https://ivibet.com/" },
    "blaze.bet.br": { label: "Blaze",  url: "https://blaze.com/en/" },
    betwinner:  { label: "Betwinner",  url: "https://betwinner.com/hu" },
    funbet:     { label: "Funbet",     url: "https://funbet.com/hu" },
    favbet:     { label: "Favbet",     url: "https://www.favbet.ro/ro/" },
    betano:     { label: "Betano",     url: "https://ro.betano.com/" },
    superbet:   { label: "Superbet",   url: "https://superbet.ro/" },
    fortuna:    { label: "Fortuna",    url: "https://efortuna.ro/" },
    unibet:     { label: "Unibet",     url: "https://funbet.com/hu" } /* ha kell, cseréld a helyes linkre */
  };

  // --- Quick Bet link konfiguráció ---
  const QUICK_BET_BASE = (window.location.origin || '').replace(/\/$/, '') + '/gyors';
  function buildQuickBetLink(urls){
    if (!urls || !urls.length) return '#';
    const params = new URLSearchParams();
    urls.forEach(u => params.append('irodaURL', u));
    return `${QUICK_BET_BASE}?${params.toString()}`;
  }

  // --- Case-insensitive URL param olvasás ---
  function getCaseInsensitiveParam(nameCI) {
    const params = new URLSearchParams(window.location.search);
    for (const [k, v] of params.entries()) {
      if (k.toLowerCase() === nameCI.toLowerCase()) return v;
    }
    return null;
  }
  function getMatchName(){
    return _getHiddenVal('Meccs') ?? getCaseInsensitiveParam('Meccs');
  }
  function renderMatchPill(){
    const matchName = getMatchName();
    const calc = document.querySelector('.calculator');
    if (!calc) return;

    const h1 = calc.querySelector('h1');
    if (!h1) return;

    if (!matchName || String(matchName).trim() === '') {
      const oldWrap = document.getElementById('matchPillWrap');
      if (oldWrap) oldWrap.remove();
      return;
    }

    let wrap = document.getElementById('matchPillWrap');
    if (!wrap) {
      wrap = document.createElement('div');
      wrap.id = 'matchPillWrap';
      wrap.className = 'match-wrap';

      const pill = document.createElement('div');
      pill.className = 'match-pill';
      pill.id = 'matchPill';
      pill.setAttribute('aria-label', 'Mérkőzés');
      pill.title = matchName;
      pill.innerHTML = `<span class="dot" aria-hidden="true"></span><span class="text"></span>`;

      wrap.appendChild(pill);
      h1.insertAdjacentElement('afterend', wrap);
    }

    const pillText = document.querySelector('#matchPill .text');
    if (pillText) pillText.textContent = matchName;
  }

  // Deviza módok: 'HUF' / 'EUR' / 'RON'
  let stakeMode1 = 'HUF';
  let stakeMode2 = 'HUF';

  let stake1Input, stake2Input;
  let isUpdating = false;

  const DEBOUNCE_MS   = 2000;
  let stakeRoundTimer1 = null;
  let stakeRoundTimer2 = null;

  const odds1Field = document.getElementById('odds1');
  const odds2Field = document.getElementById('odds2');
  const stakeField = document.getElementById('stake');
  const labelOdds1 = document.getElementById('labelOdds1');
  const labelOdds2 = document.getElementById('labelOdds2');
  const calcButton = document.getElementById('calcButton');
  const resultDiv  = document.getElementById('result');
  const errorDiv   = document.getElementById('error');

  let isFocusedS1 = false;
  let isFocusedS2 = false;

  // kis helper a labelhez
  const labelFor = m => (m === 'EUR' ? 'EUR' : (m === 'RON' ? 'RON' : 'Ft'));

  // BETÖLTÉSKOR
  window.addEventListener('DOMContentLoaded', () => {
    document.querySelector('.calculator')?.classList.add('visible');
    try {
      applyURLParamsToFields();

      // Hidden F1/F2/Meccs feltöltés case-insensitive
      const f1Param = getCaseInsensitiveParam('F1');
      const f2Param = getCaseInsensitiveParam('F2');
      const meccsParam = getCaseInsensitiveParam('Meccs');
      if (f1Param) { const el = _hidden('F1'); if (el) el.value = f1Param; }
      if (f2Param) { const el = _hidden('F2'); if (el) el.value = f2Param; }
      if (meccsParam) { const el = _hidden('Meccs'); if (el) el.value = meccsParam; }

      autoSetCurrencyModesFromBooks();
      renderMatchPill();

      const meccsEl = document.getElementById('Meccs');
      if (meccsEl) {
        meccsEl.addEventListener('input', renderMatchPill);
        meccsEl.addEventListener('change', renderMatchPill);
      }
      initCalculate();
    } catch (e) {
      console.error(e);
      errorDiv.textContent = 'Hiba történt a betöltéskor.';
    }
  });

  // Eszköz detektálás
  function isMobileDevice(){
    const ua = navigator.userAgent || '';
    const mobileUA = /Android|iPhone|iPad|iPod|IEMobile|Opera Mini/i.test(ua);
    const touchCoarse = window.matchMedia('(hover: none) and (pointer: coarse)').matches;
    return mobileUA || touchCoarse;
  }
  function isDesktopDevice(){
    return !isMobileDevice();
  }

  // Segédek
  function stepForHUF(valueHuf){
    const n = Number(valueHuf) || 0;
    return n < 10000 ? 50 : 100;
  }
  function stepForMode(mode, currentHufValue){
    if (mode === 'EUR') return 0.1;
    if (mode === 'RON') return 1;
    return stepForHUF(currentHufValue);
  }
  function sanitizeUrl(u) {
    try {
      const url = new URL(u, window.location.origin);
      if (url.protocol !== 'http:' && url.protocol !== 'https:') return null;
      return url.href;
    } catch { return null; }
  }
  function resolveBookmakerUrl(key, defaultUrl) {
    const override = getCaseInsensitiveParam(`${key}url`);
    if (override) {
      const sanitized = sanitizeUrl(override);
      if (sanitized) return sanitized;
    }
    return defaultUrl;
  }
  function parseNum(el) {
    return Number(String(el.value).replace(',', '.'));
  }

  function applyURLParamsToFields() {
    const params = new URLSearchParams(window.location.search);

    const customLabel1 = params.get('odds1Label');
    const customLabel2 = params.get('odds2Label');
    if (customLabel1) labelOdds1.textContent = customLabel1;
    if (customLabel2) labelOdds2.textContent = customLabel2;

    const o1 = parseFloat(params.get('odds1'));
    const o2 = parseFloat(params.get('odds2'));
    if (!isNaN(o1) && o1 >= 1.01) odds1Field.value = o1.toFixed(2);
    if (!isNaN(o2) && o2 >= 1.01) odds2Field.value = o2.toFixed(2);

    const t = parseFloat(params.get('stake'));
    if (!isNaN(t) && t > 0) stakeField.value = t.toFixed(0);

    showBookmakerButtons();
  }

  function autoSetCurrencyModesFromBooks(){
     const eurBooks = new Set(['betinasia','blaze','blaze.bet.br']);
     const ronBooks = new Set(['favbet','fortuna','unibet','superbet','betano']);

     const b1 = _getBookVal('odds1Book');
     const b2 = _getBookVal('odds2Book');
     const b1l = b1 ? String(b1).toLowerCase() : null;
     const b2l = b2 ? String(b2).toLowerCase() : null;

     stakeMode1 = (b1l && ronBooks.has(b1l)) ? 'RON'
               : (b1l && eurBooks.has(b1l)) ? 'EUR'
               : 'HUF';

     stakeMode2 = (b2l && ronBooks.has(b2l)) ? 'RON'
               : (b2l && eurBooks.has(b2l)) ? 'EUR'
               : 'HUF';
  }

  function showBookmakerButtons() {
    try {
      const bookDiv = document.getElementById("bookmakerButtons");
      const quickWrap = document.getElementById("quickBetWrap");
      bookDiv.innerHTML = "";
      if (quickWrap) quickWrap.innerHTML = "";

      const books = [];
      const seen  = new Set();

      const odds1Book = _getBookVal("odds1Book");
      const odds2Book = _getBookVal("odds2Book");

      [odds1Book, odds2Book].filter(Boolean).forEach(keyRaw => {
        const key = String(keyRaw).toLowerCase();
        const bm  = bookmakers[key];
        if (!bm || seen.has(key)) return;

        const url = resolveBookmakerUrl(key, bm.url);
        books.push({ key, label: bm.label, url });
        seen.add(key);
      });

      // Gyors fogadás link + "Oldalak megnyitása egyszerre" – ha van legalább 1 iroda
      if (books.length && quickWrap) {
        // Gyors megnyitás (külső /gyors oldalra)
        const quick = document.createElement("a");
        quick.id = "quickBetBtn";
        quick.className = "book-link";
        const quickUrls = collectBookmakerUrls();
        quick.href = buildQuickBetLink(quickUrls);
        quick.target = "_blank";
        quick.rel = "noopener";
        quick.textContent = "Gyors megnyitás";
        quickWrap.appendChild(quick);

        // Oldalak megnyitása egyszerre – közvetlenül, egy kattintásra
        const openAll = document.createElement("button");
        openAll.id = "openAllBtn";
        openAll.type = "button";
        openAll.className = "book-link";
        openAll.textContent = "Oldalak megnyitása egyszerre";
        openAll.addEventListener('click', () => {
          const urls = collectBookmakerUrls();
          if (!urls.length) return;
          let openedCount = 0;
          urls.forEach(u => {
            try {
              const w = window.open(u, '_blank', 'noopener');
              if (w) openedCount++;
            } catch {}
          });
          if (openedCount === 0) showPopupHint();
        });
        quickWrap.appendChild(openAll);
      }

      // Iroda gombok (egymás mellett – CSS grid intézi)
      books.forEach(bm => {
        const a = document.createElement("a");
        a.className = "book-link";
        a.href = bm.url;
        a.target = "_blank";
        a.rel = "noreferrer noopener";
        a.textContent = bm.label;
        bookDiv.appendChild(a);
      });

      // Ha van iroda, a “Számolás” gomb marad rejtve
      calcButton.style.display = books.length ? "none" : "inline-block";
    } catch (e) {
      console.error(e);
      calcButton.style.display = "inline-block";
    }
  }

  function updateURLParams() {
    const params = new URLSearchParams(window.location.search);
    const o1 = parseNum(odds1Field);
    const o2 = parseNum(odds2Field);
    const t  = parseNum(stakeField);

    if (Number.isFinite(o1) && o1 >= 1.01) params.set('odds1', o1.toFixed(2));
    if (Number.isFinite(o2) && o2 >= 1.01) params.set('odds2', o2.toFixed(2));
    if (Number.isFinite(t)  && t > 0)      params.set('stake', t.toFixed(0));

    history.replaceState(null, '', `${window.location.pathname}?${params.toString()}`);
  }

  ['odds1', 'odds2'].forEach((id) => {
    document.getElementById(id).addEventListener('input', () => {
      updateURLParams();
      stake1Input = null;
      stake2Input = null;
      calculateArbitrage();
    });
  });

  stakeField.addEventListener('input', () => {
    stake1Input = null;
    stake2Input = null;
    calculateArbitrage();
    updateURLParams();
  });

  function initCalculate() {
    stake1Input = null;
    stake2Input = null;
    calculateArbitrage();
  }

  // == Deviza ↔ HUF konverzió ==
  function displayToHUF(displayValue, mode){
    const n = Number(String(displayValue).replace(',', '.')) || 0;
    if (mode === 'EUR') return n * eurRate;
    if (mode === 'RON') return n * ronRate;
    return n;
  }
  function hufToDisplay(hufValue, mode){
    const n = Number(hufValue) || 0;
    if (mode === 'EUR') return (n / eurRate);
    if (mode === 'RON') return (n / ronRate);
    return n;
  }
  function formatDisplay(n, mode){
    if (mode === 'EUR') return (Math.round(n * 10) / 10).toFixed(1);
    return Math.round(n).toString(); // HUF és RON: egész
  }
  function roundToTenthEUR(x) {
    const n = Number(x);
    if (!Number.isFinite(n)) return null;
    return Math.round(n * 10) / 10;
  }

  function calculateArbitrage() {
    const MIN_ODDS = 1.01;

    const odds1      = parseFloat(odds1Field.value.replace(',', '.'));
    const odds2      = parseFloat(odds2Field.value.replace(',', '.'));
    const totalStake = parseFloat(stakeField.value.replace(',', '.')); // HUF

    resultDiv.innerHTML = '';
    errorDiv.textContent = '';

    if (isNaN(odds1) || isNaN(odds2) || isNaN(totalStake)) {
      errorDiv.textContent = 'Kérjük, adjon meg érvényes számokat minden mezőben.';
      return;
    }
    if (odds1 < MIN_ODDS || odds2 < MIN_ODDS || totalStake <= 0) {
      errorDiv.textContent = `Az oddsok legalább ${MIN_ODDS.toFixed(2)}-ek, a tét pedig legyen nagyobb 0-nál.`;
      return;
    }

    const arbPercent = 1 / odds1 + 1 / odds2;

    const initialStake1HUF = (totalStake / odds1) / arbPercent;
    const initialStake2HUF = (totalStake / odds2) / arbPercent;

    if (!stake1Input && !stake2Input) {
      renderEditableStakes(initialStake1HUF, initialStake2HUF);
      setTimeout(() => roundAll(), 0);
    } else if (!isUpdating) {
      isUpdating = true;
      writeDisplayStake(stake1Input, initialStake1HUF, stakeMode1);
      writeDisplayStake(stake2Input, initialStake2HUF, stakeMode2);
      stakeField.value  = Math.round(initialStake1HUF + initialStake2HUF).toString();
      isUpdating = false;
      updateStakeAltDisplays();
      syncInputSteps();
    }

    updateProfits(odds1, odds2);
  }

  // ==== Másolás ====
  function copyToClipboard(text) {
    if (!text && text !== 0) return Promise.resolve(false);
    if (navigator.clipboard && navigator.clipboard.writeText) {
      return navigator.clipboard.writeText(String(text)).then(() => true).catch(() => false);
    }
    try {
      const ta = document.createElement('textarea');
      ta.value = String(text);
      ta.setAttribute('readonly', '');
      ta.style.position = 'fixed';
      ta.style.opacity = '0';
      document.body.appendChild(ta);
      ta.select();
      ta.setSelectionRange(0, String(text).length);
      const ok = document.execCommand('copy');
      document.body.removeChild(ta);
      return Promise.resolve(!!ok);
    } catch {
      return Promise.resolve(false);
    }
  }
  function showCopiedState(btn, original = "📋") {
    btn.classList.add('copied');
    const prev = btn.textContent;
    btn.textContent = '✓';
    setTimeout(() => {
      btn.classList.remove('copied');
      btn.textContent = original;
    }, 1500);
  }

  // ==== Dinamikus kerekítés + léptetés (HUF térben) ====
  function roundedPairFrom(source, s1HUF, s2HUF, o1, o2){
    const stepForHufOrRon = (hufValue, mode) => {
      if (mode === 'RON') return ronRate; // egész RON HUF-térben
      return stepForHUF(hufValue);
    };

    if (source === 's2') {
      let step2 = stepForHufOrRon(s2HUF, stakeMode2);
      s2HUF = Math.round(s2HUF / step2) * step2;

      s1HUF = (s2HUF * o2) / o1;
      let step1 = stepForHufOrRon(s1HUF, stakeMode1);
      s1HUF = Math.round(s1HUF / step1) * step1;
    } else {
      let step1 = stepForHufOrRon(s1HUF, stakeMode1);
      s1HUF = Math.round(s1HUF / step1) * step1;

      s2HUF = (s1HUF * o1) / o2;
      let step2 = stepForHufOrRon(s2HUF, stakeMode2);
      s2HUF = Math.round(s2HUF / step2) * step2;
    }
    return [Math.max(0, Math.round(s1HUF)), Math.max(0, Math.round(s2HUF))];
  }

  function getDisplayStakesHUF(o1, o2){
    const rawS1Disp = stake1Input ? Number(String(stake1Input.value).replace(',', '.')) || 0 : 0;
    const rawS2Disp = stake2Input ? Number(String(stake2Input.value).replace(',', '.')) || 0 : 0;

    const rawS1HUF = displayToHUF(rawS1Disp, stakeMode1);
    const rawS2HUF = displayToHUF(rawS2Disp, stakeMode2);

    if (isFocusedS1) return roundedPairFrom('s1', rawS1HUF, (rawS1HUF * o1) / o2, o1, o2);
    if (isFocusedS2) return roundedPairFrom('s2', (rawS2HUF * o2) / o1, rawS2HUF, o1, o2);
    return roundedPairFrom('s1', rawS1HUF, rawS2HUF, o1, o2);
  }

  function commitRound(source){
    if (!stake1Input || !stake2Input) return;
    const o1 = parseFloat(odds1Field.value.replace(',', '.'));
    const o2 = parseFloat(odds2Field.value.replace(',', '.'));

    let s1HUF = displayToHUF(stake1Input.value, stakeMode1);
    let s2HUF = displayToHUF(stake2Input.value, stakeMode2);

    const [rs1HUF, rs2HUF] = roundedPairFrom(source, s1HUF, s2HUF, o1, o2);
    isUpdating = true;
    writeDisplayStake(stake1Input, rs1HUF, stakeMode1);
    writeDisplayStake(stake2Input, rs2HUF, stakeMode2);
    stakeField.value  = String(rs1HUF + rs2HUF);
    isUpdating = false;
    updateProfits(o1, o2);
    updateStakeAltDisplays();
    updateURLParams();
    syncInputSteps();
  }

  function roundAll(){
    if (!stake1Input || !stake2Input) return;
    if (isFocusedS1) { isFocusedS1 = false; commitRound('s1'); return; }
    if (isFocusedS2) { isFocusedS2 = false; commitRound('s2'); return; }
    commitRound('s1');
  }

  function triggerCommitOnUserMotion(){
    if (isFocusedS1) { isFocusedS1 = false; commitRound('s1'); return; }
    if (isFocusedS2) { isFocusedS2 = false; commitRound('s2'); return; }
  }

  function scheduleStakeRound(source) {
    if (source === 's1') {
      if (stakeRoundTimer1) clearTimeout(stakeRoundTimer1);
      stakeRoundTimer1 = setTimeout(() => commitRound('s1'), DEBOUNCE_MS);
    } else {
      if (stakeRoundTimer2) clearTimeout(stakeRoundTimer2);
      stakeRoundTimer2 = setTimeout(() => commitRound('s2'), DEBOUNCE_MS);
    }
  }

  function syncInputSteps(){
    if (stake1Input) {
      const currentHUF1 = displayToHUF(stake1Input.value, stakeMode1);
      stake1Input.step = String(stepForMode(stakeMode1, currentHUF1));
    }
    if (stake2Input) {
      const currentHUF2 = displayToHUF(stake2Input.value, stakeMode2);
      stake2Input.step = String(stepForMode(stakeMode2, currentHUF2));
    }
  }

  function writeDisplayStake(inputEl, hufValue, mode){
    const disp = hufToDisplay(hufValue, mode);
    inputEl.value = formatDisplay(disp, mode);
  }

  // ==== Élő frissítések ====
  function onStake1Change() {
    if (isUpdating) return;
    const odds1 = parseFloat(odds1Field.value.replace(',', '.'));
    const odds2 = parseFloat(odds2Field.value.replace(',', '.'));

    let s1HUF = displayToHUF(stake1Input.value, stakeMode1);
    if (!Number.isFinite(s1HUF) || s1HUF < 0) s1HUF = 0;

    const s2PreviewHUF = (s1HUF * odds1) / odds2;
    const [ , rs2HUF] = roundedPairFrom('s1', s1HUF, s2PreviewHUF, odds1, odds2);

    isUpdating = true;
    writeDisplayStake(stake2Input, rs2HUF, stakeMode2);
    stakeField.value  = String(Math.round(s1HUF + rs2HUF));
    isUpdating = false;

    updateProfits(odds1, odds2);
    updateStakeAltDisplays();
    updateURLParams();
  }

  function onStake2Change() {
    if (isUpdating) return;
    const odds1 = parseFloat(odds1Field.value.replace(',', '.'));
    const odds2 = parseFloat(odds2Field.value.replace(',', '.'));

    let s2HUF = displayToHUF(stake2Input.value, stakeMode2);
    if (!Number.isFinite(s2HUF) || s2HUF < 0) s2HUF = 0;

    const s1PreviewHUF = (s2HUF * odds2) / odds1;
    const [rs1HUF, ] = roundedPairFrom('s2', s1PreviewHUF, s2HUF, odds1, odds2);

    isUpdating = true;
    writeDisplayStake(stake1Input, rs1HUF, stakeMode1);
    stakeField.value  = String(Math.round(rs1HUF + s2HUF));
    isUpdating = false;

    updateProfits(odds1, odds2);
    updateStakeAltDisplays();
    updateURLParams();
  }

  // ==== Profit és alternatív kijelzés ====
  function updateProfits(odds1, odds2) {
    if (!stake1Input || !stake2Input) return;

    const [s1HUF, s2HUF] = getDisplayStakesHUF(odds1, odds2);
    const totalInvested = s1HUF + s2HUF;

    const profit1 = s1HUF * odds1 - totalInvested;
    const profit2 = s2HUF * odds2 - totalInvested;
    const guaranteed = Math.min(profit1, profit2);

    const p1pct = totalInvested > 0 ? (profit1 / totalInvested) * 100 : 0;
    const p2pct = totalInvested > 0 ? (profit2 / totalInvested) * 100 : 0;
    const guaranteedPercent = totalInvested > 0 ? (guaranteed / totalInvested) * 100 : 0;

    const nfFt = new Intl.NumberFormat('hu-HU');

    // === RON-os kijelzés, ha mindkét tét RON módban van ===
    const useRON = (stakeMode1 === 'RON' && stakeMode2 === 'RON');
    const formatProfit = (amtHUF) => {
      if (!Number.isFinite(amtHUF)) return useRON ? '- RON' : '- Ft';
      if (useRON) {
        const ron = Math.round(amtHUF / ronRate);
        return `${ron.toLocaleString('hu-HU')} RON`;
      }
      return `${nfFt.format(Math.round(amtHUF))} Ft`;
    };

    const p1El = document.getElementById('profit1Value');
    const p2El = document.getElementById('profit2Value');
    const gv   = document.getElementById('guaranteedValue');

    p1El.textContent = formatProfit(profit1);
    p2El.textContent = formatProfit(profit2);
    gv.textContent   = Number.isFinite(guaranteed)
      ? `${formatProfit(guaranteed)} (${guaranteedPercent.toFixed(2)}%)`
      : (useRON ? '- RON' : '- Ft');

    const LOW_BAND = 1;

    [p1El, p2El, gv].forEach(el => {
      el.classList.remove('is-positive','is-zero','is-negative');
    });

    if (Number.isFinite(profit1)) {
      if (Math.abs(p1pct) <= LOW_BAND) p1El.classList.add('is-zero');
      else if (profit1 > 0)            p1El.classList.add('is-positive');
      else                             p1El.classList.add('is-negative');
    }

    if (Number.isFinite(profit2)) {
      if (Math.abs(p2pct) <= LOW_BAND) p2El.classList.add('is-zero');
      else if (profit2 > 0)            p2El.classList.add('is-positive');
      else                             p2El.classList.add('is-negative');
    }

    if (Number.isFinite(guaranteed)) {
      if (Math.abs(guaranteedPercent) <= LOW_BAND) gv.classList.add('is-zero');
      else if (guaranteed > 0)                    gv.classList.add('is-positive');
      else if (guaranteed < 0)                    gv.classList.add('is-negative');
      else                                        gv.classList.add('is-zero');
    }

    stakeField.value = String(Math.round(totalInvested));
  }

  function updateStakeAltDisplays() {
    if (!stake1Input || !stake2Input) return;
    const odds1 = parseFloat(odds1Field.value.replace(',', '.'));
    the odds2 = parseFloat(odds2Field.value.replace(',', '.'));
    const [s1HUF, s2HUF] = getDisplayStakesHUF(odds1, odds2);

    const s1AltEl = document.getElementById('stake1Alt');
    const s2AltEl = document.getElementById('stake2Alt');

    if (stakeMode1 === 'EUR') {
      const ft1 = Number.isFinite(s1HUF) ? s1HUF : null;
      if (s1AltEl){ s1AltEl.className = 'ft-value'; s1AltEl.textContent = ft1 != null ? `= ${ft1.toLocaleString('hu-HU')} Ft` : ''; }
    } else if (stakeMode1 === 'RON') {
      const ft1 = Number.isFinite(s1HUF) ? s1HUF : null;
      if (s1AltEl){ s1AltEl.className = 'ft-value'; s1AltEl.textContent = ft1 != null ? `= ${ft1.toLocaleString('hu-HU')} Ft` : ''; }
    } else {
      const eur1 = Number.isFinite(s1HUF) ? roundToTenthEUR(s1HUF / eurRate) : null;
      if (s1AltEl){ s1AltEl.className = 'eur-value'; s1AltEl.textContent = eur1 != null ? `= ${eur1.toLocaleString('hu-HU', { minimumFractionDigits: 2, maximumFractionDigits: 2 })} EUR` : ''; }
    }

    if (stakeMode2 === 'EUR') {
      const ft2 = Number.isFinite(s2HUF) ? s2HUF : null;
      if (s2AltEl){ s2AltEl.className = 'ft-value'; s2AltEl.textContent = ft2 != null ? `= ${ft2.toLocaleString('hu-HU')} Ft` : ''; }
    } else if (stakeMode2 === 'RON') {
      const ft2 = Number.isFinite(s2HUF) ? s2HUF : null;
      if (s2AltEl){ s2AltEl.className = 'ft-value'; s2AltEl.textContent = ft2 != null ? `= ${ft2.toLocaleString('hu-HU')} Ft` : ''; }
    } else {
      const eur2 = Number.isFinite(s2HUF) ? roundToTenthEUR(s2HUF / eurRate) : null;
      if (s2AltEl){ s2AltEl.className = 'eur-value'; s2AltEl.textContent = eur2 != null ? `= ${eur2.toLocaleString('hu-HU', { minimumFractionDigits: 2, maximumFractionDigits: 2 })} EUR` : ''; }
    }

    const s1Label = document.getElementById('stake1Label');
    const s2Label = document.getElementById('stake2Label');
    if (s1Label) s1Label.textContent = `${labelOdds1.textContent} tét (${labelFor(stakeMode1)}):`;
    if (s2Label) s2Label.textContent = `${labelOdds2.textContent} tét (${labelFor(stakeMode2)}):`;
  }

  function toggleStakeMode(which){
    const odds1 = parseFloat(odds1Field.value.replace(',', '.'));
    const odds2 = parseFloat(odds2Field.value.replace(',', '.'));

    if (which === 1 && stake1Input) {
      const currentHUF = displayToHUF(stake1Input.value, stakeMode1);
      stakeMode1 = (stakeMode1 === 'EUR') ? 'HUF' : 'EUR';
      writeDisplayStake(stake1Input, currentHUF, stakeMode1);
    }
    if (which === 2 && stake2Input) {
      const currentHUF = displayToHUF(stake2Input.value, stakeMode2);
      stakeMode2 = (stakeMode2 === 'EUR') ? 'HUF' : 'EUR';
      writeDisplayStake(stake2Input, currentHUF, stakeMode2);
    }

    syncInputSteps();
    updateProfits(odds1, odds2);
    updateStakeAltDisplays();
  }

  // Betöltéskori kerekítés + mozgásfigyelők a commit-hoz
  window.addEventListener('DOMContentLoaded', () => {
    setTimeout(() => roundAll(), 0);

    window.addEventListener('wheel', () => triggerCommitOnUserMotion(), { passive: true });
    window.addEventListener('scroll', () => triggerCommitOnUserMotion(), { passive: true });
    window.addEventListener('touchmove', () => triggerCommitOnUserMotion(), { passive: true });

    document.addEventListener('pointerdown', (e) => {
      if (stake1Input && stake1Input.contains?.(e.target)) return;
      if (stake2Input && stake2Input.contains?.(e.target)) return;
      triggerCommitOnUserMotion();
    }, { capture: true });
  });

  /* =========================
     Beállítások MODÁL + Auto Open (csak Desktop)
     ========================= */
  const LS_KEY_AUTO_OPEN = 'autoOpenLinks';
  const SS_KEY_ALREADY_TRIED = 'autoOpen_tried';

  (function initSettingsUI(){
    if (!isDesktopDevice()){
      const btn = document.getElementById('settingsBtn');
      const modal = document.getElementById('settingsModal');
      const backdrop = document.getElementById('settingsBackdrop');
      if (btn) btn.style.display = 'none';
      if (modal) modal.remove();
      if (backdrop) backdrop.remove();
      return;
    }

    const btn = document.getElementById('settingsBtn');
    const modal = document.getElementById('settingsModal');
    const backdrop = document.getElementById('settingsBackdrop');
    const closeX = document.getElementById('settingsClose');
    const toggle = document.getElementById('autoOpenToggle');
    const guideLinkEl = document.getElementById('guideLink');

    const openSettings = ()=>{
      backdrop.hidden = false; modal.hidden = false;
      requestAnimationFrame(()=>{ backdrop.classList.add('show'); modal.classList.add('show'); });
    };
    const closeSettings = ()=>{
      backdrop.classList.remove('show'); modal.classList.remove('show');
      setTimeout(()=>{ backdrop.hidden = true; modal.hidden = true; }, 180);
    };

    if (guideLinkEl) guideLinkEl.href = GUIDE_URL;

    const saved = (localStorage.getItem(LS_KEY_AUTO_OPEN) || 'false') === 'true';
    toggle.checked = saved;

    btn.addEventListener('click', openSettings);
    closeX.addEventListener('click', closeSettings);
    backdrop.addEventListener('click', closeSettings);
    document.addEventListener('keydown', (e)=>{ if(e.key==='Escape') closeSettings(); });

    toggle.addEventListener('change', ()=>{ localStorage.setItem(LS_KEY_AUTO_OPEN, toggle.checked ? 'true' : 'false'); });
  })();

  // Eszköz/nézet detektálás egyszerűsített
  function isMobileView(){
    return window.matchMedia('(max-width: 600px)').matches;
  }

  // Popup – mobilon középre modál, PC-n toast
  function showPopupHint(){
    if (isMobileView()){
      const backdrop = document.createElement('div');
      backdrop.className = 'modal-backdrop show';

      const modal = document.createElement('div');
      modal.className = 'modal popup-modal show';
      modal.innerHTML = `
        <div class="box">
          <div class="hdr">
            <div class="title">Automatikus nyitás blokkolva</div>
          </div>
          <div class="txt">
            Ha nem működik az automatikus megnyitás: nézd meg az útmutatót a Discord <b>#fogadási-beállítások</b> csatornában.
          </div>
          <div class="btns">
            <a class="inline-link" href="${GUIDE_URL}" target="_blank" rel="noopener">Útmutató</a>
          </div>
        </div>
      `;

      const removeAll = ()=>{ try{ backdrop.remove(); modal.remove(); }catch{} };
      document.body.appendChild(backdrop);
      document.body.appendChild(modal);
      setTimeout(removeAll, POPUP_AUTO_DISMISS_MS);
      [backdrop, modal].forEach(el=> el.addEventListener('click', removeAll));
    } else {
      const calc = document.querySelector('.calculator');
      if (!calc) return;

      const toast = document.createElement('div');
      toast.className = 'calc-toast';
      toast.innerHTML = `
        <div class="title">Automatikus nyitás blokkolva</div>
        <div class="txt">Ha nem működik az automatikus megnyitás: nézd meg az útmutatót a Discord <b>#fogadási-beállítások</b> csatornában.</div>
        <div class="btns">
          <a class="inline-link" href="${GUIDE_URL}" target="_blank" rel="noopener">Útmutató</a>
        </div>
      `;
      calc.appendChild(toast);
      requestAnimationFrame(()=> toast.classList.add('show'));

      const removeToast = ()=>{ try{ toast.remove(); }catch{} };
      setTimeout(removeToast, POPUP_AUTO_DISMISS_MS);
      toast.addEventListener('click', removeToast);
    }
  }

  // Összegyűjti a linkeket (hidden mezők vagy URL paramok alapján)
  function collectBookmakerUrls(){
    const keys = [_getBookVal('odds1Book'), _getBookVal('odds2Book')].filter(Boolean);
    const seen = new Set();
    const urls = [];

    keys.forEach(kRaw=>{
      const k = String(kRaw).toLowerCase();
      const bm = bookmakers[k];
      if (!bm || seen.has(k)) return;
      const url = resolveBookmakerUrl(k, bm.url);
      if (url) { urls.push(url); seen.add(k); }
    });

    return urls;
  }

  // Próbál automatikusan megnyitni (csak 1x/session)
  function maybeAutoOpenLinks(){
    const enabled = (localStorage.getItem(LS_KEY_AUTO_OPEN) || 'false') === 'true';
    if (!enabled) return;
    if (sessionStorage.getItem(SS_KEY_ALREADY_TRIED) === '1') return;

    const urls = collectBookmakerUrls();
    if (!urls.length) return;

    sessionStorage.setItem(SS_KEY_ALREADY_TRIED, '1');

    let openedCount = 0;
    urls.forEach(u=>{
      try{
        const w = window.open(u, '_blank', 'noopener');
        if (w) openedCount++;
      }catch{}
    });

    if (openedCount === 0){
      showPopupHint();
    }
  }

  window.addEventListener('DOMContentLoaded', ()=>{
    setTimeout(maybeAutoOpenLinks, 300);
  });

  // Hidden oddsBook mezők figyelése
  window.addEventListener('DOMContentLoaded', () => {
    ['odds1Book','odds2Book'].forEach(id=>{
      const el = document.getElementById(id);
      if (!el) return;
      el.addEventListener('input', () => {
        autoSetCurrencyModesFromBooks();
        showBookmakerButtons();
        updateStakeAltDisplays();
        const o1 = parseFloat(odds1Field.value.replace(',', '.'));
        const o2 = parseFloat(odds2Field.value.replace(',', '.'));
        updateProfits(o1, o2);
      });
    });
  });

  // ==== Szerkeszthető tétek + F1/F2 badge ====
  function renderEditableStakes(initialStake1HUF, initialStake2HUF) {
    resultDiv.innerHTML = '';

    // ODDS 1 blokk
    const row1 = document.createElement('div');
    row1.className = 'row';

    const label1 = document.createElement('span');
    label1.className = 'label-text stake-title';
    label1.id = 'stake1Label';
    label1.textContent = `${labelOdds1.textContent} tét (${labelFor(stakeMode1)}):`;

    const stake1Box = document.createElement('div');
    stake1Box.style.display = 'flex';
    stake1Box.style.flexDirection = 'column';
    stake1Box.style.width = '100%';

    // F1 badge
    const f1Text = _getHiddenVal('F1') ?? getCaseInsensitiveParam('F1');
    if (f1Text) {
      const f1Badge = document.createElement('div');
      f1Badge.className = 'bet-pill';
      f1Badge.textContent = f1Text;
      stake1Box.appendChild(f1Badge);
    }

    const inputWithCopy1 = document.createElement('div');
    inputWithCopy1.className = 'input-with-copy';

    const copyBtn1 = document.createElement('button');
    copyBtn1.type = 'button';
    copyBtn1.className = 'copy-btn';
    copyBtn1.setAttribute('aria-label', 'Tét másolása');
    copyBtn1.textContent = '📋';

    stake1Input = document.createElement('input');
    stake1Input.type  = 'number';
    stake1Input.min   = '0';
    stake1Input.step  = '1';
    stake1Input.className = 'value-input copyable';
    writeDisplayStake(stake1Input, initialStake1HUF, stakeMode1);

    stake1Input.addEventListener('focus', () => { isFocusedS1 = true; });
    stake1Input.addEventListener('input', () => {
      onStake1Change();
      scheduleStakeRound('s1');
      syncInputSteps();
    });
    stake1Input.addEventListener('keydown', (e) => {
      if (e.key === 'Enter') {
        isFocusedS1 = false;
        commitRound('s1');
        stake1Input.blur();
      }
    });
    stake1Input.addEventListener('blur', () => {
      isFocusedS1 = false;
      commitRound('s1');
    });
    stake1Input.addEventListener('dblclick', async () => {
      isFocusedS1 = false; commitRound('s1');
      const ok = await copyToClipboard(stake1Input.value);
      if (ok) showCopiedState(copyBtn1);
    });
    copyBtn1.addEventListener('click', async () => {
      isFocusedS1 = false; commitRound('s1');
      setTimeout(async () => {
        const ok = await copyToClipboard(stake1Input.value);
        if (ok) showCopiedState(copyBtn1);
      }, 0);
    });

    inputWithCopy1.appendChild(stake1Input);
    inputWithCopy1.appendChild(copyBtn1);

    const stake1AltWrap = document.createElement('div');
    stake1AltWrap.className = 'alt-wrap';

    const stake1Alt = document.createElement('span');
    stake1Alt.id = 'stake1Alt';
    stake1Alt.className = stakeMode1 === 'EUR' ? 'ft-value' : 'eur-value';

    const swapInline1 = document.createElement('img');
    swapInline1.src = 'icon8-refresh.png';
    swapInline1.alt = 'Deviza váltás';
    swapInline1.title = 'Deviza váltás (HUF ⇄ EUR)';
    swapInline1.className = 'swap-emoji-inline';
    swapInline1.addEventListener('click', () => toggleStakeMode(1));

    stake1AltWrap.appendChild(stake1Alt);
    stake1AltWrap.appendChild(swapInline1);

    stake1Box.appendChild(inputWithCopy1);
    stake1Box.appendChild(stake1AltWrap);

    row1.appendChild(label1);
    row1.appendChild(stake1Box);

    // ODDS 2 blokk
    const row2 = document.createElement('div');
    row2.className = 'row';

    const label2 = document.createElement('span');
    label2.className = 'label-text stake-title';
    label2.id = 'stake2Label';
    label2.textContent = `${labelOdds2.textContent} tét (${labelFor(stakeMode2)}):`;

    const stake2Box = document.createElement('div');
    stake2Box.style.display = 'flex';
    stake2Box.style.flexDirection = 'column';
    stake2Box.style.width = '100%';

    // F2 badge
    const f2Text = _getHiddenVal('F2') ?? getCaseInsensitiveParam('F2');
    if (f2Text) {
      const f2Badge = document.createElement('div');
      f2Badge.className = 'bet-pill';
      f2Badge.textContent = f2Text;
      stake2Box.appendChild(f2Badge);
    }

    const inputWithCopy2 = document.createElement('div');
    inputWithCopy2.className = 'input-with-copy';

    const copyBtn2 = document.createElement('button');
    copyBtn2.type = 'button';
    copyBtn2.className = 'copy-btn';
    copyBtn2.setAttribute('aria-label', 'Tét másolása');
    copyBtn2.textContent = '📋';

    stake2Input = document.createElement('input');
    stake2Input.type  = 'number';
    stake2Input.min   = '0';
    stake2Input.step  = '1';
    stake2Input.className = 'value-input copyable';
    writeDisplayStake(stake2Input, initialStake2HUF, stakeMode2);

    stake2Input.addEventListener('focus', () => { isFocusedS2 = true; });
    stake2Input.addEventListener('input', () => {
      onStake2Change();
      scheduleStakeRound('s2');
      syncInputSteps();
    });
    stake2Input.addEventListener('keydown', (e) => {
      if (e.key === 'Enter') {
        isFocusedS2 = false;
        commitRound('s2');
        stake2Input.blur();
      }
    });
    stake2Input.addEventListener('blur', () => {
      isFocusedS2 = false;
      commitRound('s2');
    });
    stake2Input.addEventListener('dblclick', async () => {
      isFocusedS2 = false; commitRound('s2');
      const ok = await copyToClipboard(stake2Input.value);
      if (ok) showCopiedState(copyBtn2);
    });
    copyBtn2.addEventListener('click', async () => {
      isFocusedS2 = false; commitRound('s2');
      setTimeout(async () => {
        const ok = await copyToClipboard(stake2Input.value);
        if (ok) showCopiedState(copyBtn2);
      }, 0);
    });

    inputWithCopy2.appendChild(stake2Input);
    inputWithCopy2.appendChild(copyBtn2);

    const stake2AltWrap = document.createElement('div');
    stake2AltWrap.className = 'alt-wrap';

    const stake2Alt = document.createElement('span');
    stake2Alt.id = 'stake2Alt';
    stake2Alt.className = stakeMode2 === 'EUR' ? 'ft-value' : 'eur-value';

    const swapInline2 = document.createElement('img');
    swapInline2.src = 'icon8-refresh.png';
    swapInline2.alt = 'Deviza váltás';
    swapInline2.title = 'Deviza váltás (HUF ⇄ EUR)';
    swapInline2.className = 'swap-emoji-inline';
    swapInline2.addEventListener('click', () => toggleStakeMode(2));

    stake2AltWrap.appendChild(stake2Alt);
    stake2AltWrap.appendChild(swapInline2);

    stake2Box.appendChild(inputWithCopy2);
    stake2Box.appendChild(stake2AltWrap);

    row2.appendChild(label2);
    row2.appendChild(stake2Box);

    // Profit sorok
    const rowProfit1 = document.createElement('div');
    rowProfit1.className = 'row';
    rowProfit1.id = 'profit1Row';
    const labelP1 = document.createElement('span');
    labelP1.className = 'label-text';
    labelP1.textContent = 'Ha az 1-es nyer:';
    const valueP1 = document.createElement('span');
    valueP1.id = 'profit1Value';
    valueP1.className = 'value-text';
    rowProfit1.appendChild(labelP1);
    rowProfit1.appendChild(valueP1);

    const rowProfit2 = document.createElement('div');
    rowProfit2.className = 'row';
    rowProfit2.id = 'profit2Row';
    const labelP2 = document.createElement('span');
    labelP2.className = 'label-text';
    labelP2.textContent = 'Ha a 2-es nyer:';
    const valueP2 = document.createElement('span');
    valueP2.id = 'profit2Value';
    valueP2.className = 'value-text';
    rowProfit2.appendChild(labelP2);
    rowProfit2.appendChild(valueP2);

    const rowGuaranteed = document.createElement('div');
    rowGuaranteed.className = 'row guaranteed-row';
    rowGuaranteed.style.borderTop = '1px solid #444c56';
    rowGuaranteed.style.paddingTop = '10px';
    rowGuaranteed.style.marginTop = '12px';
    const labelG = document.createElement('span');
    labelG.className = 'guaranteed-label';
    labelG.textContent = 'Garantált eredmény:';
    const valueG = document.createElement('span');
    valueG.id = 'guaranteedValue';
    valueG.className = 'guaranteed-value';
    rowGuaranteed.appendChild(labelG);
    rowGuaranteed.appendChild(valueG);

    resultDiv.appendChild(row1);
    resultDiv.appendChild(row2);
    resultDiv.appendChild(rowProfit1);
    resultDiv.appendChild(rowProfit2);
    resultDiv.appendChild(rowGuaranteed);

    const odds1 = parseFloat(odds1Field.value.replace(',', '.'));
    const odds2 = parseFloat(odds2Field.value.replace(',', '.'));
    updateProfits(odds1, odds2);
    updateStakeAltDisplays();
    syncInputSteps();
  }
  </script>
</body>
</html>
