<!DOCTYPE html>
<html lang="hu">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Arbitrázs Kalkulátor – Dark Mode</title>
  <style>
  :root{
    --green:#00ff88;
    --green-2:#00e6a8;
    --teal:#00ffc4;
    --teal-2:#00bfa5;
  }

  body {
    background: linear-gradient(135deg, #121212, #1e1e1e);
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    display: flex;
    min-height: 100vh;
    margin: 0;
    justify-content: center;
    padding: 20px 10px;
    color: #e0e0e0;
    overflow-y: auto;
  }
  .calculator {
    background: rgba(34,40,49,0.85);
    border-radius: 20px;
    box-shadow: 0 8px 24px rgba(0,0,0,0.18), 0 2px 8px #00ffa825;
    backdrop-filter: blur(8px);
    border: 1px solid rgba(255,255,255,0.05);
    padding: 30px 35px;
    max-width: 400px;
    width: 100%;
    text-align: center;
    margin: auto;

    opacity: 0;
    transform: scale(0.94) translateY(30px);
    transition: opacity 0.6s cubic-bezier(.6,1.5,.7,1), transform 0.6s cubic-bezier(.6,1.5,.7,1);
    will-change: opacity, transform;
    position: relative; /* a settings gomb & desktop toast miatt */
  }
  .calculator.visible { opacity: 1; transform: scale(1) translateY(0); }

  .logo-wrapper { display: flex; justify-content: center; align-items: center; margin-bottom: 22px; }
  .logo {
    width: 68px; height: 68px; object-fit: cover; border-radius: 50%;
    border: 3px solid rgba(255,255,255,0.07);
    box-shadow: 0 4px 14px #00ff8855; background: #fff0; display: block; margin: 0 auto;
  }
  h1 { margin: 0 0 22px; font-weight: 700; color: var(--green); font-size: 1.8rem; }

  label { display: block; text-align: left; margin-top: 16px; margin-bottom: 8px; font-weight: 600; color: #b0b0b0; font-size: 1rem; }

  /* Odds mezők (változatlan) */
  input[type="number"] {
    width: 100%; padding: 12px 14px; font-size: 1rem; border-radius: 10px;
    border: 2px solid #444c56; background-color: #1f262d; color: #e0e0e0;
    outline-color: var(--green); transition: border-color 0.25s ease, box-shadow 0.25s ease;
    box-sizing: border-box; margin-bottom: 4px; box-shadow: 0 1px 6px #00ffc021 inset;
    font-variant-numeric: tabular-nums;
  }
  input[type="number"]::placeholder { color: #777c85; }
  input[type="number"]:focus { border-color: var(--green); box-shadow: 0 0 8px #00ff8844, 0 1px 6px #00ffc021 inset; }

  button, .book-link {
    margin-top: 24px; width: 100%; display: inline-block; text-decoration: none; text-align: center;
    font-weight: 700; font-size: 1.2rem; padding: 14px 0; border-radius: 12px; cursor: pointer;
  }
  button {
    background: linear-gradient(90deg, #00c853, #009624); border: none; color: white;
    box-shadow: 0 4px 15px rgba(0, 200, 83, 0.7); transition: background 0.3s ease, box-shadow 0.25s ease;
  }
  button:hover, button:focus { background: linear-gradient(90deg, #009624, #00c853); box-shadow: 0 6px 20px rgba(0, 200, 83, 0.9); }

  .book-link {
    background: linear-gradient(90deg, #00ffcc, #00bfa5); color: #1e1e1e;
    box-shadow: 0 4px 15px rgba(0, 255, 204, 0.7); transition: background 0.3s ease, box-shadow 0.25s ease; margin-top: 18px;
  }
  .book-link:hover, .book-link:focus { background: linear-gradient(90deg, #00bfa5, #00ffcc); box-shadow: 0 6px 20px rgba(0, 255, 204, 0.9); }

  /* Finom elválasztó a fogadóiroda gombok után (csak ha nem üres) */
  #bookmakerButtons:not(:empty){ margin-top: 6px; margin-bottom: 12px; }
  #bookmakerButtons:not(:empty)::after{
    content:""; display:block; height:1px; margin:12px 0 4px 0;
    background: linear-gradient(90deg, transparent, #00ffcc33, transparent);
  }

  .result { margin-top: 28px; font-weight: 700; font-size: 1.15rem; line-height: 1.5; color: #e0e0e0; text-align: left; }
  .row { margin-top: 5px; display: flex; justify-content: space-between; align-items: flex-start; flex-wrap: wrap; gap: 8px; }
  .label-text { color: #b0b0b0; font-weight: 600; }
  .value-text { color: var(--green); font-weight: 800; text-shadow: 0 0 6px #00ff8844; font-variant-numeric: tabular-nums; }
  .guaranteed-label { color: #a0ffb4; font-weight: 700; }
  .guaranteed-value { color: #a0ffb4; font-weight: 800; text-shadow: 0 0 8px #a0ffb455; white-space: nowrap; font-variant-numeric: tabular-nums; }
  .tip-label { color: #ffd166; font-weight: 700; font-size: 1rem; }
  .tip-value { color: #ffd166; font-weight: 600; font-size: 0.95rem; line-height: 1.3; margin-bottom: 8px; text-align: left; }
  .eur-value, .ft-value { font-size: 0.78em; color: #23ffd6; font-weight: 600; font-variant-numeric: tabular-nums; }

  .alt-wrap{ display:flex; justify-content:flex-end; align-items:center; gap:8px; margin-top: 2px; min-height: 1.2em; }
  .swap-emoji-inline{ width: 1em; height: 1em; cursor: pointer; user-select: none; }

  .error { color: #ff5252; margin-top: 14px; font-weight: 600; }

  #stake, label[for="stake"] { display: none; }

  .input-with-copy { position: relative; width: 100%; }

  /* ——— MINIMÁL TUNING: a két tét mező kinézete ——— */

  /* 1) a „Odds X tét” címkék: akcent-csík + erősebb tipó */
  #stake1Label, #stake2Label{
    position: relative;
    padding-left: 12px;
    font-weight: 800;
    letter-spacing: .01em;
    color: #d8fbea; /* picit világosabb */
    margin-bottom: 6px;
  }
  #stake1Label::before, #stake2Label::before{
    content:""; position:absolute; left:0; top:50%;
    width:4px; height:66%; transform: translateY(-50%);
    border-radius: 6px;
    box-shadow: 0 0 10px rgba(0,0,0,.25);
  }
  #stake1Label::before{ background: linear-gradient(180deg, var(--green), var(--green-2)); }
  #stake2Label::before{ background: linear-gradient(180deg, var(--teal), var(--teal-2)); }

  /* 2) a zöld bet-pill finomítása (F1/F2) */
  .bet-pill{
    align-self: flex-start;
    display: inline-flex;
    padding: 6px 10px 6px 28px; /* hely az ikonpöttynek */
    border-radius: 9999px;
    font-size: .85rem;
    font-weight: 800;
    background: linear-gradient(180deg, rgba(0,255,136,.07), rgba(0,255,136,.05));
    border: 1px solid rgba(0,255,136,.22);
    color: #c8ffdf;
    box-shadow: 0 2px 8px rgba(0,255,136,.08), inset 0 1px 0 rgba(255,255,255,.05);
    margin: 0 0 6px 0;
    max-width: 100%;
    line-height: 1.15;
    word-break: break-word;
    position: relative;
  }
  .bet-pill::before{
    content:""; position:absolute; left:10px; top:50%;
    width:10px; height:10px; border-radius:50%;
    transform: translateY(-50%);
    background: radial-gradient(circle at 30% 30%, var(--green), #0a855e);
    box-shadow: 0 0 10px #00ff8890;
  }

  /* 3) tét input: diszkrét mélység + fókusz gyűrű, padding a copy-gombnak */
  .value-input{
    width: 100%;
    padding: 12px 14px;
    padding-right: 52px; /* hely a másoló gombnak */
    font-size: 1rem; border-radius: 12px;
    border: 1px solid #3a434c;
    background: linear-gradient(180deg, #1e2630, #1b2128);
    color: #e0e0e0;
    transition: border-color .2s ease, box-shadow .2s ease, background .2s ease;
    box-shadow: 0 1px 0 rgba(255,255,255,.02) inset, 0 1px 6px rgba(0,255,192,.13) inset;
    text-align: right;
    font-variant-numeric: tabular-nums;
    caret-color: var(--green);
  }
  .value-input:hover{
    border-color:#4a5560;
    background: linear-gradient(180deg, #202a34, #1b2128);
  }
  .value-input:focus{
    outline: none;
    border-color: var(--green);
    box-shadow: 0 0 0 3px rgba(0,255,136,.15), 0 1px 6px rgba(0,255,192,.18) inset;
    background: linear-gradient(180deg, #1f2a33, #1b2128);
  }

  button.copy-btn {
    position: absolute; right: 8px; top: 8px;
    width: auto; min-width: 36px; height: 32px; padding: 0 8px; margin: 0;
    display: inline-flex; align-items: center; justify-content: center;
    border-radius: 8px; border: 1px solid var(--green);
    background: #173329; color: #bfffdc; font-size: 0.95rem; line-height: 1;
    box-shadow: 0 2px 6px rgba(0,0,0,0.25); z-index: 2; cursor: pointer;
    transition: transform .08s ease, box-shadow .2s ease;
  }
  button.copy-btn:hover, button:focus { background: #173329; box-shadow: 0 3px 10px rgba(0,255,136,0.25); }
  button.copy-btn:active { transform: scale(0.98); }
  button.copy-btn.copied { border-color: #62ff9d; color: #62ff9d; }

  @media (max-width: 400px) {
    .calculator { padding: 25px 20px; width: 100%; box-shadow: none; border-radius: 12px; }
    h1 { font-size: 1.5rem; margin-bottom: 18px; }
    label { font-size: 0.9rem; margin-top: 14px; margin-bottom: 6px; }
    input[type="number"] { font-size: 0.95rem; padding: 10px 12px; width: 100%; }
    button, .book-link { font-size: 1.1rem; padding: 12px 0; }
    .result { font-size: 1rem; margin-top: 22px; }
    .row { margin-top: 5px; flex-wrap: wrap; }
    .logo { width: 50px; height: 50px; }
    .logo-wrapper { margin-bottom: 14px; }
    button.copy-btn { right: 6px; top: 6px; height: 30px; min-width: 34px; }

    .guaranteed-row .guaranteed-label,
    .guaranteed-row .guaranteed-value { font-size: .95rem; }
  }

  .is-positive { color: #a0ffb4 !important; text-shadow: 0 0 8px #a0ffb455 !important; }
  .is-zero     { color: #ffd166 !important; text-shadow: 0 0 8px #ffd16655 !important; }
  .is-negative { color: #ff6b6b !important; text-shadow: 0 0 8px #ff6b6b55 !important; }

  /* === Középre felugró modál – általános (Settings + mobil popup) === */
  .modal-backdrop{
    position: fixed; inset: 0; background: rgba(0,0,0,.45);
    opacity: 0; pointer-events: none; transition: opacity .18s ease; z-index: 999;
  }
  .modal-backdrop.show{ opacity: 1; pointer-events: auto; }

  .modal{
    position: fixed; inset: 0; display: grid; place-items: center;
    z-index: 1000; pointer-events: none;
  }
  .modal .box{
    width: min(92vw, 420px);
    background: rgba(34,40,49,.98);
    border:1px solid rgba(255,255,255,.08);
    border-radius:16px; padding:16px;
    box-shadow: 0 20px 60px rgba(0,0,0,.45);
    transform: translateY(10px) scale(.98); opacity: 0;
    transition: transform .2s ease, opacity .2s ease;
  }
  .modal.show{ pointer-events: auto; }
  .modal.show .box{ transform: translateY(0) scale(1); opacity:1; }

  .modal .hdr{ display:flex; align-items:center; justify-content: space-between; gap:12px; margin-bottom:8px; }
  .modal .title{ font-weight:800; color:#e6ffe6; font-size:1.05rem; }
  .modal .close-x{ cursor:pointer; opacity:.85; user-select:none; font-size:1.1rem; padding:6px; }

  /* Beállítások gomb (kép) a kártya jobb felső sarkában */
  .settings-btn{
    position:absolute; top:12px; right:12px;
    width:36px; height:36px; border-radius:8px; padding:0;
    border:1px solid rgba(255,255,255,.08);
    background: rgba(34,40,49,.8); backdrop-filter: blur(6px);
    display:flex; align-items:center; justify-content:center; cursor:pointer;
    box-shadow: 0 4px 12px rgba(0,0,0,.25);
    z-index: 3;
  }
  .settings-btn:hover{ box-shadow: 0 6px 16px rgba(0,0,0,.35); }
  .settings-btn img{ width:22px; height:22px; display:block; }

  /* Szebb iOS-szerű toggle */
  .setting-row{ display:flex; align-items:center; gap:12px; padding:10px 0; }
  .setting-row .lbl{ font-weight:700; color:#e6ffe6; }
  .setting-row .desc{ color:#aab; font-size:.92rem; line-height:1.25; margin-top:2px; }

  .toggle{ margin-left:auto; position:relative; width:56px; height:30px; -webkit-tap-highlight-color:transparent; }
  .toggle input{ display:none; }
  .toggle .track{
    position:absolute; inset:0; border-radius:999px; overflow:hidden;
    background:#3a414a; box-shadow: inset 0 1px 6px rgba(0,0,0,.35);
    transition: background .18s ease;
  }
  .toggle .knob{
    position:absolute; top:3px; left:3px; width:24px; height:24px; border-radius:50%;
    background:#f0f0f0; box-shadow: 0 2px 8px rgba(0,0,0,.35);
    transition: transform .18s ease, background .18s ease;
  }
  .toggle input:checked + .track{ background: linear-gradient(90deg,#00c853,#00e676); }
  .toggle input:checked + .track .knob{ transform: translateX(26px); background:#fff; }

  /* Popup (mobil – középre felugró) */
  .popup-modal .title{ font-weight:800; color:#ffd166; }
  .popup-modal .txt{ color:#e0e0e0; line-height:1.35; margin-top:6px; }
  .modal .btns{ display:flex; gap:10px; justify-content:flex-end; margin-top:14px; flex-wrap:wrap; }
  .inline-link{
    border:1px solid var(--green); background:#173329; color:#bfffdc; border-radius:10px;
    padding:10px 14px; text-decoration:none; font-weight:700;
  }

  /* Popup (desktop – toast a kalkulátor mellett, jobb felső) */
  .calc-toast{
    position: absolute;
    top: 10px; left: 100%; margin-left: 12px;
    width: 320px; max-width: 36vw;
    background: rgba(34,40,49,.98);
    border:1px solid rgba(255,255,255,.08);
    border-radius:14px; padding:12px 14px;
    box-shadow: 0 14px 40px rgba(0,0,0,.35);
    opacity: 0; transform: translateY(-6px); transition: opacity .2s ease, transform .2s ease;
    z-index: 2;
  }
  .calc-toast.show{ opacity:1; transform: translateY(0); }
  .calc-toast .title{ font-weight:800; color:#ffd166; font-size:1rem; }
  .calc-toast .txt{ color:#e0e0e0; font-size:.95rem; line-height:1.3; margin-top:4px; }
  .calc-toast .btns{ display:flex; justify-content:flex-end; gap:8px; margin-top:10px; }

  /* ⛔ Rejtés érintős/mobil eszközökön – safety net CSS */
  @media (hover:none) and (pointer:coarse), (max-width: 700px) {
    .settings-btn { display: none !important; }
    #settingsModal, #settingsBackdrop { display: none !important; }
  }

  /* Mérkőzés badge a cím alatt (változatlan) */
  .match-wrap{
    display:flex; justify-content:center; align-items:center;
    margin: -6px 0 12px 0;
  }
  .match-pill{
    display:inline-flex; align-items:center; gap:8px;
    padding: 8px 12px;
    border-radius: 9999px;
    font-size: .92rem;
    font-weight: 800;
    background: rgba(0,255,204,.08);
    border: 1px solid rgba(0,255,204,.22);
    color: #d6fff6;
    box-shadow: 0 2px 10px rgba(0,255,204,.08);
    max-width: 100%;
    line-height: 1.15;
    word-break: break-word;
    text-align: center;
  }
  .match-pill .dot{
    width:8px; height:8px; border-radius:50%;
    background:var(--teal); box-shadow:0 0 8px #00ffcc88; flex:0 0 auto;
  }
  </style>
</head>
<body>
  <div class="calculator" role="main" aria-label="Arbitrázs kalkulátor">

    <!-- === Beállítások gomb (PC/Laptop) – mobilon JS-ből és CSS-ből is rejtve === -->
    <button class="settings-btn" id="settingsBtn" aria-label="Beállítások">
      <img src="123.png" alt="Beállítások">
    </button>

    <!-- === Beállítások MODÁL + háttér === -->
    <div class="modal-backdrop" id="settingsBackdrop" hidden></div>
    <div class="modal" id="settingsModal" hidden>
      <div class="box">
        <div class="hdr">
          <div class="title">Beállítások</div>
          <span class="close-x" id="settingsClose">✕</span>
        </div>

        <div class="setting-row">
          <div style="max-width: calc(100% - 120px);">
            <div class="lbl">Fogadóirodák automatikus nyitása</div>
            <div class="desc">Betöltéskor a linkelt irodák megnyitása új fülön (ha szerepelnek az URL-ben).</div>
          </div>
          <label class="toggle" title="Be/Ki">
            <input type="checkbox" id="autoOpenToggle">
            <span class="track"><span class="knob"></span></span>
          </label>
        </div>

        <hr style="border:none; border-top:1px solid rgba(255,255,255,.08); margin:12px 0;">

        <div class="setting-row">
          <div style="max-width: calc(100% - 120px);">
            <div class="lbl">Segítség</div>
            <div class="desc">Ha az automatikus nyitás nem működik, olvasd el az útmutatót a Discordon.</div>
          </div>
          <a id="guideLink" class="inline-link" href="#" target="_blank" rel="noopener" title="Útmutató">Útmutató</a>
        </div>
      </div>
    </div>
    <!-- === /Beállítások === -->

    <div class="logo-wrapper">
      <img src="logo21.png" alt="Logó" class="logo" />
    </div>

    <h1>Arbitrázs Kalkulátor</h1>

    <input type="text" id="odds1Book" hidden>
    <input type="text" id="odds2Book" hidden>
    <input type="text" id="Meccs" hidden>
    <input type="text" id="F1" hidden>
    <input type="text" id="F2" hidden>

    <label for="odds1" id="labelOdds1">Odds 1</label>
    <input type="number" id="odds1" step="0.01" min="1.01" placeholder="pl. 1,74" value="1.74" />

    <label for="odds2" id="labelOdds2">Odds 2</label>
    <input type="number" id="odds2" step="0.01" min="1.01" placeholder="pl. 2,63" value="2.63" />

    <label for="stake">Teljes tét (Ft)</label>
    <input type="number" id="stake" step="1" min="1" placeholder="pl. 10000" value="10000" />

    <div id="bookmakerButtons"></div>
    <button id="calcButton" type="button" onclick="initCalculate()" aria-label="Számolás indítása">
      Számolás
    </button>

    <div id="error" class="error" role="alert"></div>
    <div id="result" class="result" aria-live="polite"></div>
  </div>

  <script>
  // === Hidden mezők olvasása (helper) ===
  const _hidden = id => document.getElementById(id);
  const _getHiddenVal = id => {
    const el = _hidden(id);
    return (el && el.value && String(el.value).trim() !== '') ? el.value : null;
  };
  const _getBookVal = key => _getHiddenVal(key) ?? (new URLSearchParams(window.location.search)).get(key);

  // ==== Alapbeállítások ====
  const eurRate = 393;
  const paramsAtLoad = new URLSearchParams(window.location.search);

  // FIX DISCORD ÚTMUTATÓ LINK + Popup autózár (7.5 mp)
  const GUIDE_URL = "https://discord.com/channels/1352389902033096724/1400422649502502953/1402328347480162324";
  const POPUP_AUTO_DISMISS_MS = 7500;

  const bookmakers = {
    tippmixpro: { label: "TippMixPro", url: "https://www.tippmixpro.hu/" },
    vegas:      { label: "Vegas",      url: "https://vegas.hu/betting" },
    piwi247:    { label: "Piwi247",    url: "https://www.piwi247.com/sports" },
    boabet:     { label: "BoaBet",     url: "https://www.boabet.com/" },
    betinia:    { label: "Betinia",    url: "https://betinia.com/hu/" },
    betinasia:  { label: "BetInAsia",  url: "https://black.betinasia.com/sportsbook/football" },
    blaze:      { label: "Blaze",      url: "https://blaze.com/en/" },
    "20bet":    { label: "20bet",      url: "https://20bet.com/hu" },
    ivibet:     { label: "Ivibet",     url: "https://ivibet.com/" },
    "blaze.bet.br": { label: "Blaze",  url: "https://blaze.com/en/" },
    betwinner:  { label: "Betwinner",  url: "https://betwinner.com/hu" },
    funbet:     { label: "Funbet",     url: "https://funbet.com/hu" }
  };

  // --- Case-insensitive URL param olvasás ---
  function getCaseInsensitiveParam(nameCI) {
    const params = new URLSearchParams(window.location.search);
    for (const [k, v] of params.entries()) {
      if (k.toLowerCase() === nameCI.toLowerCase()) return v;
    }
    return null;
  }
  function getMatchName(){
    return _getHiddenVal('Meccs') ?? getCaseInsensitiveParam('Meccs');
  }
  function renderMatchPill(){
    const matchName = getMatchName();
    const calc = document.querySelector('.calculator');
    if (!calc) return;

    const h1 = calc.querySelector('h1');
    if (!h1) return;

    if (!matchName || String(matchName).trim() === '') {
      const oldWrap = document.getElementById('matchPillWrap');
      if (oldWrap) oldWrap.remove();
      return;
    }

    let wrap = document.getElementById('matchPillWrap');
    if (!wrap) {
      wrap = document.createElement('div');
      wrap.id = 'matchPillWrap';
      wrap.className = 'match-wrap';

      const pill = document.createElement('div');
      pill.className = 'match-pill';
      pill.id = 'matchPill';
      pill.setAttribute('aria-label', 'Mérkőzés');
      pill.title = matchName;
      pill.innerHTML = `<span class="dot" aria-hidden="true"></span><span class="text"></span>`;

      wrap.appendChild(pill);
      h1.insertAdjacentElement('afterend', wrap);
    }

    const pillText = document.querySelector('#matchPill .text');
    if (pillText) pillText.textContent = matchName;
  }

  // Deviza módok a tét mezőkhöz: 'HUF' vagy 'EUR'
  let stakeMode1 = 'HUF';
  let stakeMode2 = 'HUF';

  let stake1Input, stake2Input;
  let isUpdating = false;

  const DEBOUNCE_MS   = 2000;
  let stakeRoundTimer1 = null;
  let stakeRoundTimer2 = null;

  const odds1Field = document.getElementById('odds1');
  const odds2Field = document.getElementById('odds2');
  const stakeField = document.getElementById('stake');
  const labelOdds1 = document.getElementById('labelOdds1');
  const labelOdds2 = document.getElementById('labelOdds2');
  const calcButton = document.getElementById('calcButton');
  const resultDiv  = document.getElementById('result');
  const errorDiv   = document.getElementById('error');

  let isFocusedS1 = false;
  let isFocusedS2 = false;

  // BETÖLTÉSKOR
  window.addEventListener('DOMContentLoaded', () => {
    document.querySelector('.calculator')?.classList.add('visible');
    try {
      applyURLParamsToFields();

      // Hidden F1/F2/Meccs feltöltés case-insensitive módon
      const f1Param = getCaseInsensitiveParam('F1');
      const f2Param = getCaseInsensitiveParam('F2');
      const meccsParam = getCaseInsensitiveParam('Meccs');
      if (f1Param) { const el = _hidden('F1'); if (el) el.value = f1Param; }
      if (f2Param) { const el = _hidden('F2'); if (el) el.value = f2Param; }
      if (meccsParam) { const el = _hidden('Meccs'); if (el) el.value = meccsParam; }

      autoSetCurrencyModesFromBooks();
      renderMatchPill();

      const meccsEl = document.getElementById('Meccs');
      if (meccsEl) {
        meccsEl.addEventListener('input', renderMatchPill);
        meccsEl.addEventListener('change', renderMatchPill);
      }
      initCalculate();
    } catch (e) {
      console.error(e);
      errorDiv.textContent = 'Hiba történt a betöltéskor.';
    }
  });

  // ==== Eszköz detektálás (mobil vs. desktop) ====
  function isMobileDevice(){
    const ua = navigator.userAgent || '';
       const mobileUA = /Android|iPhone|iPad|iPod|IEMobile|Opera Mini/i.test(ua);
    const touchCoarse = window.matchMedia('(hover: none) and (pointer: coarse)').matches;
    return mobileUA || touchCoarse;
  }
  function isDesktopDevice(){
    return !isMobileDevice();
  }

  // ==== Segédek ====
  function stepForHUF(valueHuf){
    const n = Number(valueHuf) || 0;
    return n < 10000 ? 50 : 100;
  }
  function stepForMode(mode, currentHufValue){
    return mode === 'EUR' ? 0.1 : stepForHUF(currentHufValue);
  }

  function sanitizeUrl(u) {
    try {
      const url = new URL(u, window.location.origin);
      if (url.protocol !== 'http:' && url.protocol !== 'https:') return null;
      return url.href;
    } catch { return null; }
  }
  function resolveBookmakerUrl(key, defaultUrl) {
    const override = getCaseInsensitiveParam(`${key}url`);
    if (override) {
      const sanitized = sanitizeUrl(override);
      if (sanitized) return sanitized;
    }
    return defaultUrl;
  }
  function parseNum(el) {
    return Number(String(el.value).replace(',', '.'));
  }

  function applyURLParamsToFields() {
    const params = new URLSearchParams(window.location.search);

    const customLabel1 = params.get('odds1Label');
    const customLabel2 = params.get('odds2Label');
    if (customLabel1) labelOdds1.textContent = customLabel1;
    if (customLabel2) labelOdds2.textContent = customLabel2;

    const o1 = parseFloat(params.get('odds1'));
    const o2 = parseFloat(params.get('odds2'));
    if (!isNaN(o1) && o1 >= 1.01) odds1Field.value = o1.toFixed(2);
    if (!isNaN(o2) && o2 >= 1.01) odds2Field.value = o2.toFixed(2);

    const t = parseFloat(params.get('stake'));
    if (!isNaN(t) && t > 0) stakeField.value = t.toFixed(0);

    showBookmakerButtons();
  }

  function autoSetCurrencyModesFromBooks(){
     const eurBooks = new Set(['betinasia','blaze','blaze.bet.br']);
     const b1 = _getBookVal('odds1Book');
     const b2 = _getBookVal('odds2Book');
     stakeMode1 = (b1 && eurBooks.has(String(b1).toLowerCase())) ? 'EUR' : 'HUF';
     stakeMode2 = (b2 && eurBooks.has(String(b2).toLowerCase())) ? 'EUR' : 'HUF';
  }

  function showBookmakerButtons() {
    try {
      const bookDiv = document.getElementById("bookmakerButtons");
      bookDiv.innerHTML = "";

      const books = [];
      const seen  = new Set();

      const odds1Book = _getBookVal("odds1Book");
      const odds2Book = _getBookVal("odds2Book");

      [odds1Book, odds2Book].filter(Boolean).forEach(keyRaw => {
        const key = String(keyRaw).toLowerCase();
        const bm  = bookmakers[key];
        if (!bm || seen.has(key)) return;

        const url = resolveBookmakerUrl(key, bm.url);
        books.push({ label: bm.label, url });
        seen.add(key);
      });

      books.forEach(bm => {
        const a = document.createElement("a");
        a.className = "book-link";
        a.href = bm.url;
        a.target = "_blank";
        a.rel = "noreferrer noopener";
        a.textContent = bm.label;
        bookDiv.appendChild(a);
      });

      calcButton.style.display = books.length ? "none" : "inline-block";
    } catch (e) {
      console.error(e);
      calcButton.style.display = "inline-block";
    }
  }

  function updateURLParams() {
    const params = new URLSearchParams(window.location.search);
    const o1 = parseNum(odds1Field);
    const o2 = parseNum(odds2Field);
    const t  = parseNum(stakeField);

    if (Number.isFinite(o1) && o1 >= 1.01) params.set('odds1', o1.toFixed(2));
    if (Number.isFinite(o2) && o2 >= 1.01) params.set('odds2', o2.toFixed(2));
    if (Number.isFinite(t)  && t > 0)      params.set('stake', t.toFixed(0));

    history.replaceState(null, '', `${window.location.pathname}?${params.toString()}`);
  }

  ['odds1', 'odds2'].forEach((id) => {
    document.getElementById(id).addEventListener('input', () => {
      updateURLParams();
      stake1Input = null;
      stake2Input = null;
      calculateArbitrage();
    });
  });

  stakeField.addEventListener('input', () => {
    stake1Input = null;
    stake2Input = null;
    calculateArbitrage();
    updateURLParams();
  });

  function initCalculate() {
    stake1Input = null;
    stake2Input = null;
    calculateArbitrage();
  }

  // == Deviza ↔ HUF konverzió segédek ==
  function displayToHUF(displayValue, mode){
    const n = Number(String(displayValue).replace(',', '.')) || 0;
    return mode === 'EUR' ? n * eurRate : n;
  }
  function hufToDisplay(hufValue, mode){
    const n = Number(hufValue) || 0;
    return mode === 'EUR' ? (n / eurRate) : n;
  }
  function formatDisplay(n, mode){
    if (mode === 'EUR') return (Math.round(n * 10) / 10).toFixed(1);
    return Math.round(n).toString();
  }
  function roundToTenthEUR(x) {
    const n = Number(x);
    if (!Number.isFinite(n)) return null;
    return Math.round(n * 10) / 10;
  }

  function calculateArbitrage() {
    const MIN_ODDS = 1.01;

    const odds1      = parseFloat(odds1Field.value.replace(',', '.'));
    const odds2      = parseFloat(odds2Field.value.replace(',', '.'));
    const totalStake = parseFloat(stakeField.value.replace(',', '.')); // HUF

    resultDiv.innerHTML = '';
    errorDiv.textContent = '';

    if (isNaN(odds1) || isNaN(odds2) || isNaN(totalStake)) {
      errorDiv.textContent = 'Kérjük, adjon meg érvényes számokat minden mezőben.';
      return;
    }
    if (odds1 < MIN_ODDS || odds2 < MIN_ODDS || totalStake <= 0) {
      errorDiv.textContent = `Az oddsok legalább ${MIN_ODDS.toFixed(2)}-ek, a tét pedig legyen nagyobb 0-nál.`;
      return;
    }

    const arbPercent = 1 / odds1 + 1 / odds2;

    const initialStake1HUF = (totalStake / odds1) / arbPercent;
    const initialStake2HUF = (totalStake / odds2) / arbPercent;

    if (!stake1Input && !stake2Input) {
      renderEditableStakes(initialStake1HUF, initialStake2HUF);
      setTimeout(() => roundAll(), 0);
    } else if (!isUpdating) {
      isUpdating = true;
      writeDisplayStake(stake1Input, initialStake1HUF, stakeMode1);
      writeDisplayStake(stake2Input, initialStake2HUF, stakeMode2);
      stakeField.value  = Math.round(initialStake1HUF + initialStake2HUF).toString();
      isUpdating = false;
      updateStakeAltDisplays();
      syncInputSteps();
    }

    updateProfits(odds1, odds2);
  }

  // ==== Másolás ====
  function copyToClipboard(text) {
    if (!text && text !== 0) return Promise.resolve(false);
    if (navigator.clipboard && navigator.clipboard.writeText) {
      return navigator.clipboard.writeText(String(text)).then(() => true).catch(() => false);
    }
    try {
      const ta = document.createElement('textarea');
      ta.value = String(text);
      ta.setAttribute('readonly', '');
      ta.style.position = 'fixed';
      ta.style.opacity = '0';
      document.body.appendChild(ta);
      ta.select();
      ta.setSelectionRange(0, String(text).length);
      const ok = document.execCommand('copy');
      document.body.removeChild(ta);
      return Promise.resolve(!!ok);
    } catch {
      return Promise.resolve(false);
    }
  }
  function showCopiedState(btn, original = "📋") {
    btn.classList.add('copied');
    const prev = btn.textContent;
    btn.textContent = '✓';
    setTimeout(() => {
      btn.classList.remove('copied');
      btn.textContent = original;
    }, 1500);
  }

  // ==== Dinamikus kerekítés + léptetés (HUF térben) ====
  function roundedPairFrom(source, s1HUF, s2HUF, o1, o2){
    if (source === 's2') {
      let step2 = stepForHUF(s2HUF);
      s2HUF = Math.round(s2HUF / step2) * step2;

      s1HUF = (s2HUF * o2) / o1;
      let step1 = stepForHUF(s1HUF);
      s1HUF = Math.round(s1HUF / step1) * step1;
    } else {
      let step1 = stepForHUF(s1HUF);
      s1HUF = Math.round(s1HUF / step1) * step1;

      s2HUF = (s1HUF * o1) / o2;
      let step2 = step
